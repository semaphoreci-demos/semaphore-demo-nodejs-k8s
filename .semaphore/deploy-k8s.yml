version: v1.0
name: Deploy to Kubernetes
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
global_job_config:
  epilogue:
    always:
      commands:
        - '[[ -f report.xml ]] && test-results publish report.xml'
blocks:
  - name: Deploy to Kubernetes
    task:
      env_vars:
        - name: CLUSTER_NAME
          value: semaphore-demo-nodejs-k8s-server
      prologue:
        commands:
          - checkout
      jobs:
        - name: Deploy
          commands:
            - checkout
            - envsubst < deployment.yml > deploy-application.yml
            - kubectl apply -f deploy-application.yml || true
      secrets:
        - name: kubeconfig
    dependencies: []
after_pipeline:
  task:
    jobs:
      - name: Publish Results
        commands:
          - test-results gen-pipeline-report
